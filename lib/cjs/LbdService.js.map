{"version":3,"sources":["../../src/LbdService.ts"],"names":["namedNode","DataFactory","literal","defaultGraph","quad","variable","LbdService","session","verbose","fetch","accessService","AccessService","dataService","DataService","store","Store","q","sources","registries","asStream","mutateQuery","query","myEngine","QueryEngine","inference","context","result","resultToString","data","JSON","parse","obj","variables","type","bgp","findLowerLevel","input","Promise","resolve","reject","OWL","sameAs","LBD","hasReference","hasIdentifier","queryQuads","quadStream","on","res","addQuad","subject","id","replaceAll","predicate","value","object","translation","usedVariables","Set","aliasNumber","aliases","patterns","pattern","Object","keys","item","termType","has","newVName","push","newV","add","forEach","alias","newPattern","Array","from","webId","getProjectRegistry","lbdLoc","length","aggregator","headers","Accept","then","t","json","myProjects","LDP","contains","map","i","stakeholder","hasProjectRegistry","bindings","bind","get","err","location","undefined","inbox","url","publiclyAccessible","info","replace","q0","sparqlUpdate","q1","Aggregator","accessRights","read","append","write","control","actor","setResourceAccess","ResourceType","CONTAINER","console","log","deleteContainer"],"mappings":"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","sourcesContent":["import AccessService from \"./helpers/access-service\";\r\nimport { urlJoin } from \"url-join-ts\";\r\nimport DataService from \"./helpers/data-service\";\r\nimport { computeChecksumMd5 } from \"./helpers/utils\";\r\nimport { newEngine, IQueryResultBindings } from \"@comunica/actor-init-sparql\";\r\n// Import from \"@inrupt/solid-client\"\r\nimport {\r\n  createSolidDataset,\r\n  buildThing,\r\n  getSolidDataset,\r\n  createThing,\r\n  setThing,\r\n  setUrl,\r\n  addUrl,\r\n  getThingAll,\r\n  getUrlAll,\r\n  setDatetime,\r\n  saveSolidDatasetAt,\r\n} from \"@inrupt/solid-client\";\r\nimport { extract, streamToString } from \"./helpers/functions\";\r\nimport { RDF, SCHEMA_INRUPT, DCAT, OWL, LDP, AS, XSD, FOAF, DCTERMS } from \"@inrupt/vocab-common-rdf\";\r\nimport LBD from \"./helpers/vocab/lbds\";\r\nimport { AccessRights, ResourceType } from \"./helpers/BaseDefinitions\";\r\nimport { Session as BrowserSession } from \"@inrupt/solid-client-authn-browser\";\r\nimport { Session as NodeSession } from \"@inrupt/solid-client-authn-node\";\r\nimport { translate, toSparql } from 'sparqlalgebrajs'\r\nimport {Store, DataFactory} from 'n3'\r\nimport { QueryEngine } from \"@comunica/query-sparql\";\r\n\r\nconst { namedNode, literal, defaultGraph, quad, variable } = DataFactory;\r\n\r\nexport class LbdService {\r\n  public fetch;\r\n  public verbose: boolean = false;\r\n  public accessService: AccessService;\r\n  public dataService: DataService;\r\n  private session: BrowserSession | NodeSession;\r\n  private store: Store\r\n\r\n\r\n  /**\r\n   * \r\n   * @param session an (authenticated) session\r\n   * @param verbose optional parameter for logging purposes\r\n   */\r\n  constructor(session: BrowserSession | NodeSession, verbose: boolean = false) {\r\n    this.session = session;\r\n    this.fetch = session.fetch;\r\n    this.verbose = verbose;\r\n    this.accessService = new AccessService(session.fetch);\r\n    this.dataService = new DataService(session.fetch);\r\n    this.store = new Store()\r\n  }\r\n\r\n    /////////////////////////////////////////////////////////\r\n  ////////////////////// QUERY ////////////////////////////\r\n  /////////////////////////////////////////////////////////\r\n\r\n  public async query(q: string, { sources, registries, asStream }) {\r\n    const { query } = this.mutateQuery(q)\r\n\r\n    const myEngine = new QueryEngine();\r\n\r\n    await this.inference(myEngine, registries)\r\n    const context: any = { sources: [...sources, this.store], fetch }\r\n    const result = await myEngine.query(query, context )\r\n    const { data } = await myEngine.resultToString(result,\r\n      'application/sparql-results+json');\r\n    if (asStream) {\r\n      return data\r\n    } else {\r\n      return JSON.parse(await streamToString(data))\r\n    }\r\n  }\r\n\r\n  private findLowerLevel(obj, variables) {\r\n    if (!variables) variables = obj.variables\r\n    if (obj.type === \"bgp\") {\r\n      return { bgp: obj, variables }\r\n    } else {\r\n      return this.findLowerLevel(obj.input, variables)\r\n    }\r\n  }\r\n\r\n  private inference(myEngine, registries): Promise<void> {\r\n    return new Promise(async (resolve, reject) => {\r\n      const q = `\r\n      CONSTRUCT {\r\n       ?s1 <${OWL.sameAs}> ?s2 .\r\n       ?s2 <${OWL.sameAs}> ?s1 .\r\n      } WHERE {\r\n          ?concept1 <${LBD.hasReference}>/<${LBD.hasIdentifier}>/<http://schema.org/value> ?s1 .\r\n          ?concept2 <${LBD.hasReference}>/<${LBD.hasIdentifier}>/<http://schema.org/value> ?s2 .\r\n          ?concept1 <${OWL.sameAs}> ?concept2 .\r\n      }`\r\n      const quadStream = await myEngine.queryQuads(q, {\r\n        sources: registries,\r\n        fetch\r\n      });\r\n\r\n      quadStream.on('data', (res) => {\r\n        this.store.addQuad(quad(\r\n          namedNode(res.subject.id.replaceAll('\"', '')),\r\n          namedNode(res.predicate.value),\r\n          namedNode(res.object.id.replaceAll('\"', '')),\r\n          defaultGraph()\r\n        ))\r\n      });\r\n\r\n      quadStream.on('end', () => {\r\n        resolve()\r\n      })\r\n    })\r\n  }\r\n\r\n  private mutateQuery(query) {\r\n    const translation = translate(query);\r\n    const { bgp, variables } = this.findLowerLevel(translation, translation.variables)\r\n    const usedVariables = new Set()\r\n    let aliasNumber = 1\r\n    let aliases = {}\r\n    for (const pattern of bgp.patterns) {\r\n      for (const item of Object.keys(pattern)) {\r\n        if (pattern[item].termType === \"Variable\") {\r\n          if (usedVariables.has(pattern[item])) {\r\n            const newVName = `${pattern[item].value}_alias${aliasNumber}`\r\n            if (!aliases[pattern[item].value]) aliases[pattern[item].value] = []\r\n\r\n            aliases[pattern[item].value].push(newVName)\r\n            aliasNumber += 1\r\n            const newV = { termType: \"Variable\", value: newVName }\r\n            pattern[item] = newV\r\n          }\r\n          usedVariables.add(pattern[item])\r\n        }\r\n\r\n      }\r\n    }\r\n    Object.keys(aliases).forEach(item => {\r\n      aliases[item].forEach(alias => {\r\n        const newPattern = quad(\r\n          variable(item),\r\n          namedNode(\"http://www.w3.org/2002/07/owl#sameAs\"),\r\n          variable(alias),\r\n          defaultGraph()\r\n        )\r\n        bgp.patterns.push(newPattern)\r\n      })\r\n    })\r\n    const q: any = { type: \"project\", input: { type: \"bgp\", patterns: bgp.patterns }, variables: Array.from(usedVariables) }\r\n    return { query: toSparql(q), variables: Array.from(usedVariables) }\r\n  }\r\n\r\n\r\n  /////////////////////////////////////////////////////////\r\n  ////////////////////// PREPARATION //////////////////////\r\n  /////////////////////////////////////////////////////////\r\n  /**\r\n   * @description This function checks if the card (webId) contains a lbds:hasProjectRegistry pointer\r\n   * @param webId the webId/card to check\r\n   * @returns boolean - false: the WebID doesn't have a project registry yet / true: a project registry is mentioned in the card\r\n   */\r\n  public async validateWebId(webId: string) {\r\n    const lbdLoc = await this.getProjectRegistry(webId);\r\n    if (lbdLoc && lbdLoc.length > 0) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * @description This function retrieves the LBDserver projects from a project aggregator (e.g. a project registry or public aggregator)\r\n   * @param aggregator an LBDS aggregator, aggregating projects with lbds:aggregates\r\n   * @returns Array of LBDserver project access points (URL).\r\n   */\r\n  public async getAllProjects(aggregator) {\r\n    const data = await this.fetch(aggregator, {\r\n      headers: { Accept: \"application/ld+json\" },\r\n    }).then((t) => t.json());\r\n    const myProjects = extract(data, aggregator)[LDP.contains].map(\r\n      (i) => i[\"@id\"]\r\n    );\r\n    return myProjects;\r\n  }\r\n\r\n  /**\r\n   * @description Find the LBDserver project registry of a specific stakeholder by their WebID.\r\n   * @param stakeholder The WebID of the stakeholder from whom the project registry should be retrieved\r\n   * @returns URL of project registry\r\n   */\r\n  public async getProjectRegistry(\r\n    stakeholder: string\r\n  ): Promise<string | undefined> {\r\n    const myEngine = newEngine();\r\n    const q = `select ?loc where {<${stakeholder}> <${LBD.hasProjectRegistry}> ?loc}`;\r\n    const location = await myEngine\r\n      .query(q, { sources: [stakeholder], fetch: this.fetch })\r\n      .then((res: IQueryResultBindings) => res.bindings())\r\n      .then((bind: any) => bind.map((i) => i.get(\"?loc\").value))\r\n      .catch((err: Error) => {\r\n        throw err;\r\n      });\r\n    if (location && location.length > 0) {\r\n      return location[0];\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @description This function retrieves the LDP inbox from a particular WebID\r\n   * @param stakeholder The WebID of the stakeholder from whom the LDP inbox should be retrieved\r\n   * @returns The inbox URL\r\n   */\r\n  public async getInbox(stakeholder: string): Promise<string | undefined> {\r\n    const myEngine = newEngine();\r\n    const q = `select ?inbox where {<${stakeholder}> <${LDP.inbox}> ?inbox}`;\r\n    const inbox = await myEngine\r\n      .query(q, { sources: [stakeholder], fetch: this.fetch })\r\n      .then((res: IQueryResultBindings) => res.bindings())\r\n      .then((bind: any) => bind.map((i) => i.get(\"?inbox\").value))\r\n      .catch((err: Error) => {\r\n        throw err;\r\n      });\r\n    if (inbox && inbox.length > 0) {\r\n      return inbox[0];\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n//   public async inviteStakeholder(stakeholder: string, projectId: string) {\r\n//     const inbox = await this.getInbox(stakeholder);\r\n//     const id = v4();\r\n//     const url = inbox + id;\r\n//     const message = `<>\r\n//   a <${AS.Announce}> ;\r\n//   <${AS.actor}> <${this.session.info.webId}> ;\r\n//   <${AS.object}> <#invite> ;\r\n//   <${AS.target}> <${stakeholder}> ;\r\n//   <${AS.updated}> \"${new Date().toISOString()}\"^^${XSD.dateTime} .\r\n\r\n// <#invite> a ${LBD.ProjectInvite}; \r\n//   <${FOAF.primaryTopic}> <#project> .\r\n// <#project> a <${LBD.Project}> ;\r\n//     <${DCTERMS.identifier} \"${projectId}\" .\r\n//   `;\r\n\r\n//   const options = {\r\n//     method: \"POST\",\r\n//     body: message,\r\n//   }\r\n//     // await this.session.fetch()\r\n//   }\r\n\r\n  /**\r\n   * @description Create an LBDserver project registry\r\n   * @param url Where the project registry should be created\r\n   * @param publiclyAccessible Access rights for the project registry\r\n   * @returns the URL of the LBDserver Project Registry\r\n   */\r\n  public async createProjectRegistry(\r\n    url: string = undefined,\r\n    publiclyAccessible: boolean = true\r\n  ): Promise<string> {\r\n    try {\r\n      const stakeholder = this.session.info.webId\r\n      if (!url) url = stakeholder.replace(\"/profile/card#me\", \"/lbd/\");\r\n      \r\n      const q0 = `INSERT DATA {\r\n          <${stakeholder}> <${LBD.hasProjectRegistry}> <${url}> .\r\n        }`;\r\n      await this.dataService.sparqlUpdate(stakeholder, q0);\r\n\r\n      // create the LBD registry (container / Aggregator)\r\n      const q1 = `INSERT DATA {\r\n        <${url}> a <${LBD.Aggregator}> .\r\n      }`;\r\n\r\n      // the updates immediately creates the container\r\n      await this.dataService.sparqlUpdate(url, q1);\r\n\r\n      let accessRights: AccessRights;\r\n      let actor: string | undefined;\r\n      if (publiclyAccessible) {\r\n        accessRights = {\r\n          read: true,\r\n          append: false,\r\n          write: false,\r\n          control: false,\r\n        };\r\n      } else {\r\n        accessRights = { read: true, append: true, write: true, control: true };\r\n        actor = stakeholder;\r\n      }\r\n      await this.accessService.setResourceAccess(\r\n        url,\r\n        accessRights,\r\n        ResourceType.CONTAINER,\r\n        actor\r\n      );\r\n      return url;\r\n    } catch (error) {\r\n      console.log(`error`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @description delete a project registry at a particular location\r\n   * @param stakeholder The stakeholder (the authenticated agent)\r\n   * @param url The URL of the project registry\r\n   */\r\n  public async removeProjectRegistry(url: string) {\r\n    try {\r\n      const q0 = `DELETE {<${this.session.info.webId}> <${LBD.hasProjectRegistry}> <${url}> .}\r\n      WHERE {<${this.session.info.webId}> <${LBD.hasProjectRegistry}> ?reg .}`;\r\n      await this.dataService.sparqlUpdate(this.session.info.webId, q0);\r\n      await this.dataService.deleteContainer(url, true);\r\n    } catch (error) {\r\n      console.log(`error`, error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"file":"LbdService.js"}