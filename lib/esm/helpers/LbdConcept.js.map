{"version":3,"sources":["../../../src/helpers/LbdConcept.ts"],"names":["LbdConcept","constructor","session","registry","aliases","fetch","accessService","AccessService","dataService","DataService","references","create","id","distribution","url","q0","LBD","Concept","sparqlUpdate","push","initialized","initialize","data","delete","Error","alias","includes","addReference","identifier","dataset","referenceId","regdist","referenceUrl","identifierId","identifierUrl","idLiteral","getIdentifierType","hasReference","inDataset","hasIdentifier","inDistribution","error","console","log","deleteReference","isInt","n","startsWith","XSD","anyURI","integer","formatted","float","string"],"mappings":"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","sourcesContent":["import AccessService from \"./access-service\";\nimport DataService from \"./data-service\";\nimport { newEngine, IQueryResultBindings, ActorInitSparql } from \"@comunica/actor-init-sparql\";\n\nimport LBD from \"./vocab/lbd\";\nimport { AccessRights, ResourceType } from \"./BaseDefinitions\";\nimport LBDService from \"./LbdService\";\nimport {extract} from \"./functions\"\nimport {v4} from \"uuid\"\nimport { DCAT, DCTERMS, RDFS, XSD } from \"@inrupt/vocab-common-rdf\";\nimport mime from \"mime-types\"\nimport { Session as BrowserSession } from \"@inrupt/solid-client-authn-browser\";\nimport { Session as NodeSession} from \"@inrupt/solid-client-authn-node\";\nimport LbdProject from \"./LbdProject\";\nimport { getQueryResult } from \"./utils\";\n\nexport default class LbdConcept {\n  public fetch;\n  public accessService: AccessService;\n  public dataService: DataService;\n  private session: BrowserSession | NodeSession\n  public references: object[]\n  public aliases: string[]\n  public registry: string\n  public initialized: boolean\n\n  constructor(session: BrowserSession | NodeSession, registry) {\n    this.aliases = []\n    this.session = session\n    this.fetch = session.fetch;\n    this.accessService = new AccessService(session.fetch);\n    this.dataService = new DataService(session.fetch);\n    this.registry = registry\n    this.references = []\n  }\n\n  public async create() {\n    const id = v4()\n    const distribution = this.registry + 'data'\n    const url = distribution + \"#\" + id\n    const q0 = `INSERT DATA {<${url}> a <${LBD.Concept}> }`\n    await this.dataService.sparqlUpdate(distribution, q0)\n    this.aliases.push(url)\n    this.initialized = true\n  }\n\n  public async initialize(data: {aliases: string[], references: {dataset: string, distribution: string, identifier: string}[]}) {\n    this.aliases = data.aliases\n    this.references = data.references\n    this.initialized = true\n  }\n\n  public async delete() {\n    if (!this.initialized) throw new Error(\"Please initialize the Concept first using this.initialize() or this.create()\")\n    const distribution = this.registry + 'data'\n    for (const alias  of this.aliases) {\n      if (alias.includes(this.registry)) {\n        const q0 = `DELETE {\n          <${alias}> ?p ?o .\n        } WHERE {\n          <${alias}> ?p ?o .\n        }`\n        await this.dataService.sparqlUpdate(distribution, q0)\n      }\n    }\n\n  }\n\n  public async addReference(identifier: string, dataset: string, distribution: string) {\n    try {\n      if (!this.initialized) throw new Error(\"Please initialize the Concept first using this.initialize() or this.create()\")\n      const registry = this.registry\n      const referenceId = v4()\n      const regdist = registry + \"data\"\n      const referenceUrl = regdist + \"#\" + referenceId\n      const identifierId = v4()\n      const identifierUrl = regdist + \"#\" + identifierId\n  \n      const idLiteral = this.getIdentifierType(identifier)\n      for (const alias  of this.aliases) {\n        if (alias.includes(registry)) {\n  \n          const q0 = `INSERT DATA {\n            <${alias}> <${LBD.hasReference}> <${referenceUrl}> .\n            <${referenceUrl}> <${LBD.inDataset}> <${dataset}> ;\n              <${LBD.hasIdentifier}> <${identifierUrl}> .\n            <${identifierUrl}> <http://schema.org/value> ${idLiteral} ;\n            <${LBD.inDistribution}> <${distribution}> .\n         }`\n         await this.dataService.sparqlUpdate(regdist, q0)\n        }\n      }\n      \n      this.references.push({\n        dataset,\n        distribution,\n        identifier: idLiteral\n      })\n      return referenceUrl\n    } catch (error) {\n      console.log('error', error)\n    }\n\n\n  }\n\n  public async deleteReference(referenceUrl) {\n    const regdist = this.registry + \"data\"\n    const q0 = `DELETE {\n      ?a ?b <${referenceUrl}> .\n      <${referenceUrl}> ?p ?o ; ?q ?x.\n      ?x ?y ?z.\n    } WHERE {\n      ?a ?b <${referenceUrl}> .\n      <${referenceUrl}> ?p ?o ; ?q ?x.\n      ?x ?y ?z.\n    }`\n    console.log('q0', q0);\n    await this.dataService.sparqlUpdate(regdist, q0)\n\n    // const q1 = `DELETE {<${this.url}> <${LBD.hasReference}> <${referenceUrl}> .}`\n    // await this.dataService.sparqlUpdate(regdist, q1)\n  }\n\n  private getIdentifierType(identifier: string | number) {\n    function isInt(n) {\n      return n % 1 === 0;\n   }\n\n    if (typeof identifier === \"string\" && identifier.startsWith(\"http\")) {\n      return `\"${identifier}\"^^<${XSD.anyURI}>`\n    } else {\n      if (typeof identifier === \"number\") {\n        if (isInt(identifier)) {\n          return `\"${identifier}\"^^<${XSD.integer}>`\n        } else {\n          return {formatted: `\"${identifier}\"^^<${XSD.float}>`}\n        }\n      } else {\n        return `\"${identifier}\"^^<${XSD.string}>`\n      }\n    }\n  }\n}\n\n"],"file":"LbdConcept.js"}