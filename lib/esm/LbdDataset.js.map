{"version":3,"sources":["../../src/LbdDataset.ts"],"names":["LbdDataset","constructor","session","url","fetch","accessService","AccessService","dataService","DataService","lbdService","LbdService","checkExistence","status","method","then","result","init","data","headers","i","json","distributions","getDistributions","create","options","makePublic","datasetUrl","datasetArr","split","datasetId","length","res","createContainer","aclDefault","ACL","default","Authorization","agentClass","FOAF","Agent","sparqlUpdate","undefined","deleteFile","q","DCAT","Dataset","DCTERMS","creator","info","webId","identifier","pop","datasetRegistry","join","q0","dataset","Object","keys","key","Array","isArray","forEach","item","t","startsWith","delete","deleteContainer","update","query","addDistribution","distribution","mimetype","distributionId","dist","LbdDistribution","distributionUrls","map","id","push"],"mappings":"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","sourcesContent":["import AccessService from \"./helpers/access-service\";\r\nimport DataService from \"./helpers/data-service\";\r\n\r\nimport LBD from \"./helpers/vocab/lbds\";\r\nimport { AccessRights, ResourceType } from \"./helpers/BaseDefinitions\";\r\nimport {LbdService} from \"./LbdService\";\r\nimport {extract} from \"./helpers/functions\"\r\nimport {v4} from \"uuid\"\r\nimport { ACL, DCAT, DCTERMS, FOAF, RDFS } from \"@inrupt/vocab-common-rdf\";\r\nimport {LbdDistribution} from './LbdDistribution'\r\nimport { Session as BrowserSession } from \"@inrupt/solid-client-authn-browser\";\r\nimport { Session as NodeSession} from \"@inrupt/solid-client-authn-node\";\r\n\r\nexport class LbdDataset {\r\n  public fetch;\r\n  public accessService: AccessService;\r\n  public dataService: DataService;\r\n  public lbdService: LbdService;\r\n  public projectId: string;\r\n  public url: string;\r\n  public distributions: LbdDistribution[]\r\n  public data: object[];\r\n  public session: BrowserSession | NodeSession\r\n\r\n  constructor(session: BrowserSession | NodeSession, url: string) {\r\n    this.session = session\r\n    this.fetch = session.fetch;\r\n    this.url = url\r\n    this.accessService = new AccessService(session.fetch);\r\n    this.dataService = new DataService(session.fetch);\r\n    this.lbdService = new LbdService(session);\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @returns boolean: this dataset exists or not\r\n   */\r\n  public async checkExistence() {\r\n    const status = await this.fetch(this.url, {method: \"HEAD\"}).then(result => result.status)\r\n    if (status === 200) {\r\n      return true\r\n    } else {\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @description Draw this dataset into your application (async)\r\n   */\r\n  public async init() {\r\n    this.data = await this.fetch(this.url, {headers: {\"Accept\": \"application/ld+json\"}}).then(i => i.json())\r\n    this.distributions = this.getDistributions()\r\n  }\r\n\r\n  /**\r\n   * @description create this dataset within the active project\r\n   * @param options Optional - Object containing metadata about the dataset to be created. e.g: {[RDFS.label]: \"theLabel\"}\r\n   * @param makePublic initial access rights for the dataset (boolean)\r\n   */\r\n  public async create(\r\n    options: object = {},\r\n    makePublic?: boolean,\r\n  ) {\r\n    const datasetUrl = this.url\r\n    const datasetArr = this.url.split('/')\r\n    const datasetId = datasetArr[datasetArr.length - 2]\r\n    const status = await this.fetch(datasetUrl, {method: \"HEAD\"}).then(res => res.status)\r\n    if (status !== 200) {\r\n      await this.dataService.createContainer(datasetUrl, makePublic)\r\n\r\n      //workaround to allow inherited access rights\r\n\r\n      if (makePublic) {\r\n        let aclDefault = `INSERT {?rule <${ACL.default}> <${datasetUrl}>} WHERE {?rule a <${ACL.Authorization}> ; <${ACL.agentClass}> <${FOAF.Agent}>}`\r\n        await this.dataService.sparqlUpdate(datasetUrl + \".acl\", aclDefault)\r\n      }\r\n\r\n      if (makePublic === undefined) {\r\n        this.dataService.deleteFile(datasetUrl + \".acl\")\r\n      }\r\n    }\r\n\r\n    let q = `INSERT DATA {<${datasetUrl}> a <${DCAT.Dataset}> ; <${DCTERMS.creator}> <${this.session.info.webId}> ; <${DCTERMS.identifier}> \"${datasetId}\". }`\r\n\r\n    await this.dataService.sparqlUpdate(datasetUrl, q)\r\n\r\n    datasetArr.pop()\r\n    datasetArr.pop()\r\n    const datasetRegistry = datasetArr.join(\"/\") + \"/\"\r\n    let q0 = `INSERT DATA {<${datasetRegistry}> <${DCAT.dataset}> <${datasetUrl}> . }`\r\n\r\n    await this.dataService.sparqlUpdate(datasetRegistry, q0)\r\n\r\n    \r\n    if (Object.keys(options).length > 0) {\r\n      let q0 = `INSERT DATA { `\r\n      for (const key of Object.keys(options)) {\r\n        if (Array.isArray(options[key])) {\r\n          options[key].forEach((item :string) => {\r\n            let t\r\n            if (item.startsWith(\"http\")) {\r\n              t = `<${item}>`\r\n            } else {\r\n              t = `\"${item}\"`\r\n            }\r\n            q0 += `<${datasetUrl}> <${key}> ${t} .`\r\n          })\r\n        } else {\r\n          let t\r\n          if (options[key].startsWith(\"http\")) {\r\n            t = `<${options[key]}>`\r\n          } else {\r\n            t = `\"${options[key]}\"`\r\n          }\r\n          q0 += `<${datasetUrl}> <${key}> ${t} .`\r\n        }\r\n      }    \r\n      q0 += \"}\"\r\n      await this.dataService.sparqlUpdate(datasetUrl, q0)\r\n    }\r\n    await this.init()\r\n  }\r\n\r\n  /**\r\n   * @description delete this dataset\r\n   * @returns void\r\n   */\r\n  public async delete() {\r\n    await this.dataService.deleteContainer(this.url, true)\r\n    return\r\n  }\r\n\r\n  /**\r\n   * @description Update the dataset with SPARQL (dangerous - watch out!)\r\n   * @param query The SPARQL query with which to update the dataset\r\n   */\r\n  public async update(query) {\r\n      await this.dataService.sparqlUpdate(this.url, query)\r\n  }\r\n\r\n  /////////////////////////////////////////////////////////\r\n  //////////////////// DISTRIBUTIONS///////////////////////\r\n  /////////////////////////////////////////////////////////\r\n  /**\r\n   * @description create a distribution for this dataset\r\n   * @param distribution The file to upload as a dump of the dataset\r\n   * @param mimetype The mimetype of the distribution (if omitted it is guessed)\r\n   * @param options options (currently not implemented)\r\n   * @param distributionId the ID of the distribution - normally UUID, but can be overridden\r\n   * @param makePublic initial access rights for the dataset (boolean)\r\n   * @returns the distribution object\r\n   */\r\n  public async addDistribution(distribution: File | Buffer, mimetype? ,options: object = {}, distributionId: string = v4(), makePublic: boolean = false) {      \r\n    const dist = new LbdDistribution(this.session, this, distributionId)\r\n    await dist.create(distribution, {}, mimetype, makePublic)\r\n    return dist\r\n  }\r\n\r\n  /**\r\n   * @description get an Array of distribution URLs of this dataset\r\n   * @returns an Array of distribution URLs\r\n   */\r\n  public getDistributions() {\r\n      const dataset = extract(this.data, this.url)\r\n      if (dataset[DCAT.distribution]) {\r\n        const distributionUrls = dataset[DCAT.distribution].map(i => i[\"@id\"])\r\n        const distributions = []\r\n        for (const url of distributionUrls) {\r\n          const id = url.split('/')[url.split('/').length -1]\r\n          const dist = new LbdDistribution(this.session, this, id)\r\n          distributions.push(dist)\r\n        }\r\n        return distributions\r\n      } else return []\r\n  }\r\n\r\n}\r\n\r\n"],"file":"LbdDataset.js"}